-- ==========================================
-- SCRIPT MAESTRO DE INICIALIZACIÓN (Robust Version)
-- BiblioTech Pro - VPS Edition
-- ==========================================


-- Configuración de sesión
ALTER SESSION SET CONTAINER=XEPDB1;
ALTER SESSION SET CURRENT_SCHEMA = biblioteca;
GRANT UNLIMITED TABLESPACE TO biblioteca;

-- Limpieza preventiva
BEGIN
    FOR r IN (SELECT table_name FROM all_tables WHERE owner = 'BIBLIOTECA') LOOP
        EXECUTE IMMEDIATE 'DROP TABLE BIBLIOTECA.' || r.table_name || ' CASCADE CONSTRAINTS';
    END LOOP;
END;
/

-- 1. TABLAS PRINCIPALES
-- ==========================================

CREATE TABLE biblioteca.SOCIO (
    ID_SOCIO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USUARIO VARCHAR2(50) NOT NULL UNIQUE,
    PASSWORD_HASH VARCHAR2(255) NOT NULL,
    ROL VARCHAR2(20) CHECK (ROL IN ('SOCIO', 'BIBLIOTECARIO', 'ADMIN')) NOT NULL,
    PENALIZACION_HASTA DATE,
    MAX_PRESTAMOS_ACTIVOS NUMBER DEFAULT 3 NOT NULL,
    NOMBRE VARCHAR2(100),
    EMAIL VARCHAR2(100)
);

CREATE TABLE biblioteca.LIBRO (
    ID_LIBRO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ISBN VARCHAR2(20) UNIQUE NOT NULL,
    TITULO VARCHAR2(200) NOT NULL,
    AUTOR VARCHAR2(100) NOT NULL,
    CATEGORIA VARCHAR2(50),
    ANIO NUMBER(4)
);

CREATE TABLE biblioteca.EJEMPLAR (
    ID_EJEMPLAR NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_LIBRO NUMBER NOT NULL,
    CODIGO_BARRAS VARCHAR2(50) UNIQUE NOT NULL,
    ESTADO VARCHAR2(20) CHECK (ESTADO IN ('DISPONIBLE', 'BLOQUEADO', 'PRESTADO', 'BAJA')) NOT NULL,
    UBICACION VARCHAR2(100),
    VERSION NUMBER DEFAULT 0,
    CONSTRAINT FK_EJEMPLAR_LIBRO FOREIGN KEY (ID_LIBRO) REFERENCES biblioteca.LIBRO(ID_LIBRO)
);

CREATE TABLE biblioteca.BLOQUEO (
    ID_BLOQUEO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_SOCIO NUMBER NOT NULL,
    ID_EJEMPLAR NUMBER NOT NULL,
    FECHA_INICIO TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    FECHA_FIN TIMESTAMP NOT NULL,
    ESTADO VARCHAR2(20) CHECK (ESTADO IN ('ACTIVO', 'CANCELADO', 'EXPIRADO', 'CONVERTIDO')) NOT NULL,
    CONSTRAINT FK_BLOQUEO_SOCIO FOREIGN KEY (ID_SOCIO) REFERENCES biblioteca.SOCIO(ID_SOCIO),
    CONSTRAINT FK_BLOQUEO_EJEMPLAR FOREIGN KEY (ID_EJEMPLAR) REFERENCES biblioteca.EJEMPLAR(ID_EJEMPLAR)
);

CREATE TABLE biblioteca.PRESTAMO (
    ID_PRESTAMO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_SOCIO NUMBER NOT NULL,
    ID_EJEMPLAR NUMBER NOT NULL,
    FECHA_PRESTAMO DATE DEFAULT SYSDATE NOT NULL,
    FECHA_PREVISTA_DEVOLUCION DATE NOT NULL,
    FECHA_DEVOLUCION_REAL DATE,
    ESTADO VARCHAR2(20) CHECK (ESTADO IN ('ACTIVO', 'DEVUELTO')) NOT NULL,
    ID_BLOQUEO NUMBER,
    CONSTRAINT FK_PRESTAMO_SOCIO FOREIGN KEY (ID_SOCIO) REFERENCES biblioteca.SOCIO(ID_SOCIO),
    CONSTRAINT FK_PRESTAMO_EJEMPLAR FOREIGN KEY (ID_EJEMPLAR) REFERENCES biblioteca.EJEMPLAR(ID_EJEMPLAR),
    CONSTRAINT FK_PRESTAMO_BLOQUEO FOREIGN KEY (ID_BLOQUEO) REFERENCES biblioteca.BLOQUEO(ID_BLOQUEO)
);

-- Índices
CREATE INDEX biblioteca.IDX_EJEMPLAR_LIBRO ON biblioteca.EJEMPLAR (ID_LIBRO);
CREATE INDEX biblioteca.IDX_BLOQUEO_SOCIO ON biblioteca.BLOQUEO (ID_SOCIO);
CREATE INDEX biblioteca.IDX_PRESTAMO_SOCIO ON biblioteca.PRESTAMO (ID_SOCIO);
CREATE UNIQUE INDEX biblioteca.IDX_UN_BLOQUEO_ACTIVO ON biblioteca.BLOQUEO (CASE WHEN ESTADO = 'ACTIVO' THEN ID_SOCIO ELSE NULL END);



-- 3. SEED DATA
-- ==========================================

-- Usuarios (Password: password)
INSERT INTO biblioteca.SOCIO (USUARIO, PASSWORD_HASH, ROL, NOMBRE, EMAIL, MAX_PRESTAMOS_ACTIVOS) VALUES ('admin', '$2a$10$BA0QvPo6W1sgf2kx7g9C/ulfV.CI8lmDJ/HJczwPrEtOPPAwsePdW', 'ADMIN', 'Administrador', 'admin@biblio.com', 3);
INSERT INTO biblioteca.SOCIO (USUARIO, PASSWORD_HASH, ROL, NOMBRE, EMAIL, MAX_PRESTAMOS_ACTIVOS) VALUES ('biblio', '$2a$10$BA0QvPo6W1sgf2kx7g9C/ulfV.CI8lmDJ/HJczwPrEtOPPAwsePdW', 'BIBLIOTECARIO', 'Bibliotecario Jefe', 'biblio@biblio.com', 3);
INSERT INTO biblioteca.SOCIO (USUARIO, PASSWORD_HASH, ROL, NOMBRE, EMAIL, MAX_PRESTAMOS_ACTIVOS) VALUES ('socio1', '$2a$10$BA0QvPo6W1sgf2kx7g9C/ulfV.CI8lmDJ/HJczwPrEtOPPAwsePdW', 'SOCIO', 'Juan Socio', 'juan@email.com', 3);
INSERT INTO biblioteca.SOCIO (USUARIO, PASSWORD_HASH, ROL, NOMBRE, EMAIL, MAX_PRESTAMOS_ACTIVOS) VALUES ('superdev', '$2a$10$BA0QvPo6W1sgf2kx7g9C/ulfV.CI8lmDJ/HJczwPrEtOPPAwsePdW', 'ADMIN', 'Super Developer', 'dev@biblio.com', 5);

-- Libros
INSERT INTO biblioteca.LIBRO (ISBN, TITULO, AUTOR, CATEGORIA, ANIO) VALUES ('978-0134685991', 'Effective Java', 'Joshua Bloch', 'Tecnología', 2018);
INSERT INTO biblioteca.LIBRO (ISBN, TITULO, AUTOR, CATEGORIA, ANIO) VALUES ('978-0451524935', '1984', 'George Orwell', 'Novela', 1949);
INSERT INTO biblioteca.LIBRO (ISBN, TITULO, AUTOR, CATEGORIA, ANIO) VALUES ('978-0547928227', 'The Hobbit', 'J.R.R. Tolkien', 'Fantasía', 1937);

-- Ejemplares (3 copias de cada uno)
-- Effective Java
INSERT INTO biblioteca.EJEMPLAR (ID_LIBRO, CODIGO_BARRAS, ESTADO, UBICACION) VALUES ((SELECT ID_LIBRO FROM biblioteca.LIBRO WHERE ISBN='978-0134685991'), 'EJ-JAVA-1', 'DISPONIBLE', 'Estantería T1-1');
INSERT INTO biblioteca.EJEMPLAR (ID_LIBRO, CODIGO_BARRAS, ESTADO, UBICACION) VALUES ((SELECT ID_LIBRO FROM biblioteca.LIBRO WHERE ISBN='978-0134685991'), 'EJ-JAVA-2', 'DISPONIBLE', 'Estantería T1-2');
INSERT INTO biblioteca.EJEMPLAR (ID_LIBRO, CODIGO_BARRAS, ESTADO, UBICACION) VALUES ((SELECT ID_LIBRO FROM biblioteca.LIBRO WHERE ISBN='978-0134685991'), 'EJ-JAVA-3', 'DISPONIBLE', 'Estantería T1-3');

-- 1984
INSERT INTO biblioteca.EJEMPLAR (ID_LIBRO, CODIGO_BARRAS, ESTADO, UBICACION) VALUES ((SELECT ID_LIBRO FROM biblioteca.LIBRO WHERE ISBN='978-0451524935'), 'EJ-1984-1', 'DISPONIBLE', 'Estantería N1-1');
INSERT INTO biblioteca.EJEMPLAR (ID_LIBRO, CODIGO_BARRAS, ESTADO, UBICACION) VALUES ((SELECT ID_LIBRO FROM biblioteca.LIBRO WHERE ISBN='978-0451524935'), 'EJ-1984-2', 'DISPONIBLE', 'Estantería N1-2');
INSERT INTO biblioteca.EJEMPLAR (ID_LIBRO, CODIGO_BARRAS, ESTADO, UBICACION) VALUES ((SELECT ID_LIBRO FROM biblioteca.LIBRO WHERE ISBN='978-0451524935'), 'EJ-1984-3', 'DISPONIBLE', 'Estantería N1-3');

-- The Hobbit
INSERT INTO biblioteca.EJEMPLAR (ID_LIBRO, CODIGO_BARRAS, ESTADO, UBICACION) VALUES ((SELECT ID_LIBRO FROM biblioteca.LIBRO WHERE ISBN='978-0547928227'), 'EJ-HOB-1', 'DISPONIBLE', 'Estantería F1-1');
INSERT INTO biblioteca.EJEMPLAR (ID_LIBRO, CODIGO_BARRAS, ESTADO, UBICACION) VALUES ((SELECT ID_LIBRO FROM biblioteca.LIBRO WHERE ISBN='978-0547928227'), 'EJ-HOB-2', 'DISPONIBLE', 'Estantería F1-2');
INSERT INTO biblioteca.EJEMPLAR (ID_LIBRO, CODIGO_BARRAS, ESTADO, UBICACION) VALUES ((SELECT ID_LIBRO FROM biblioteca.LIBRO WHERE ISBN='978-0547928227'), 'EJ-HOB-3', 'DISPONIBLE', 'Estantería F1-3');

-- Historial
INSERT INTO biblioteca.PRESTAMO (ID_SOCIO, ID_EJEMPLAR, FECHA_PRESTAMO, FECHA_PREVISTA_DEVOLUCION, FECHA_DEVOLUCION_REAL, ESTADO)
VALUES (
    (SELECT ID_SOCIO FROM biblioteca.SOCIO WHERE USUARIO='socio1'),
    (SELECT ID_EJEMPLAR FROM biblioteca.EJEMPLAR WHERE CODIGO_BARRAS='EJ-JAVA-1'),
    SYSDATE - 30, SYSDATE - 15, SYSDATE - 20, 'DEVUELTO'
);

-- Préstamo activo
INSERT INTO biblioteca.PRESTAMO (ID_SOCIO, ID_EJEMPLAR, FECHA_PRESTAMO, FECHA_PREVISTA_DEVOLUCION, ESTADO)
VALUES (
    (SELECT ID_SOCIO FROM biblioteca.SOCIO WHERE USUARIO='socio1'),
    (SELECT ID_EJEMPLAR FROM biblioteca.EJEMPLAR WHERE CODIGO_BARRAS='EJ-1984-1'),
    SYSDATE - 5, SYSDATE + 10, 'ACTIVO'
);

-- Reserva activa
INSERT INTO biblioteca.BLOQUEO (ID_SOCIO, ID_EJEMPLAR, FECHA_INICIO, FECHA_FIN, ESTADO)
VALUES (
    (SELECT ID_SOCIO FROM biblioteca.SOCIO WHERE USUARIO='socio1'),
    (SELECT ID_EJEMPLAR FROM biblioteca.EJEMPLAR WHERE CODIGO_BARRAS='EJ-HOB-1'),
    SYSDATE, SYSDATE + 1, 'ACTIVO'
);

COMMIT;
