# ============================================================
# BiblioTech Pro - Configuración VPS (Puertos 9140-9149)
# ============================================================
version: '3.8'

services:
  # =========================================================
  # ORACLE DATABASE (Puerto 9140)
  # =========================================================
  oracle-db:
    image: gvenzl/oracle-xe:21-slim
    container_name: bibliotech-oracle-vps
    ports:
      - "9140:1521"
    environment:
      ORACLE_PASSWORD: ${ORACLE_PASSWORD:-Oracle123}
      APP_USER: ${DB_USER:-biblioteca}
      APP_USER_PASSWORD: ${DB_PASSWORD:-biblioteca123}
    volumes:
      - oracle-data:/opt/oracle/oradata
      - ./db:/docker-entrypoint-initdb.d:ro
    restart: unless-stopped
    networks:
      - bibliotech-net
    healthcheck:
      test: [ "CMD", "healthcheck.sh" ]
      interval: 60s
      timeout: 30s
      retries: 5

  # =========================================================
  # BACKEND SPRING BOOT (Puerto 9141)
  # =========================================================
  # Para el VPS es mejor containerizarlo también
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: bibliotech-backend-vps
    ports:
      - "9141:9091"
    environment:
      # Conexión interna a base de datos (nombre del servicio)
      SPRING_DATASOURCE_URL: jdbc:oracle:thin:@oracle-db:1521/XEPDB1
      SPRING_DATASOURCE_USERNAME: ${DB_USER:-biblioteca}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-biblioteca123}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      oracle-db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - bibliotech-net

  # =========================================================
  # FRONTEND NGINX (Puerto 9142)
  # =========================================================
  nginx:
    image: nginx:alpine
    container_name: bibliotech-nginx-vps
    ports:
      - "9142:80"
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./deploy/nginx/vps.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - bibliotech-net

  # =========================================================
  # TELEGRAM BOT (Sin puerto expuesto)
  # =========================================================
  telegram-bot:
    build:
      context: ./bot
      dockerfile: Dockerfile
    container_name: bibliotech-bot-vps
    environment:
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      # URL interna del backend
      API_URL: http://backend:9091/api
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - bibliotech-net

networks:
  bibliotech-net:
    driver: bridge

volumes:
  oracle-data:
    name: bibliotech-oracle-data-vps
