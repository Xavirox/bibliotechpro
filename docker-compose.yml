# ============================================================
# BiblioTech Pro - Docker Compose
# ============================================================
# Despliegue completo con:
#   - Nginx (servidor frontend)
#   - Oracle Database 21c XE
#
# USO:
#   docker-compose up -d          # Iniciar servicios
#   docker-compose logs -f        # Ver logs
#   docker-compose down           # Detener todo
#   docker-compose down -v        # Detener y borrar datos
# ============================================================

services:
  # =========================================================
  # NGINX - Servidor Frontend
  # =========================================================
  nginx:
    image: nginx:alpine
    container_name: bibliotech-nginx
    ports:
      - "8000:80"
    volumes:
      # Archivos del frontend
      - ./frontend:/usr/share/nginx/html:ro
      # Configuración personalizada de Nginx
      - ./deploy/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - oracle-db
    restart: unless-stopped
    networks:
      - bibliotech-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # =========================================================
  # ORACLE DATABASE 21c XE
  # =========================================================
  oracle-db:
    image: gvenzl/oracle-xe:21-slim
    container_name: bibliotech-oracle
    ports:
      - "1521:1521"
    environment:
      # Contraseña para SYSTEM y SYS
      ORACLE_PASSWORD: ${ORACLE_PASSWORD:-Oracle123}
      # Usuario de la aplicación
      APP_USER: ${DB_USER:-biblioteca}
      APP_USER_PASSWORD: ${DB_PASSWORD:-biblioteca123}
    volumes:
      # Persistencia de datos
      - oracle-data:/opt/oracle/oradata
      # Scripts de inicialización (se ejecutan al crear el contenedor)
      - ./db:/docker-entrypoint-initdb.d:ro
    restart: unless-stopped
    networks:
      - bibliotech-network
    healthcheck:
      test: [ "CMD", "healthcheck.sh" ]
      interval: 60s
      timeout: 30s
      retries: 5
      start_period: 180s

  # =========================================================
  # AI SERVICE (Python/FastAPI)
  # =========================================================
  ai-service:
    build:
      context: ./ai_service
      dockerfile: Dockerfile
    container_name: bibliotech-ai
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    ports:
      - "8001:8000" # Expose internally for debug, but mainly on network
    networks:
      - bibliotech-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

# =========================================================
# REDES
# =========================================================
networks:
  bibliotech-network:
    driver: bridge

# =========================================================
# VOLÚMENES PERSISTENTES
# =========================================================
volumes:
  oracle-data:
    name: bibliotech-oracle-data
